---
- name: Determine modules to be installed
# =======================================
  hosts: localhost
  gather_facts: yes

  tasks:
    - name: Setting default module flags
      set_fact:
        all_modules:
          - openvpn
          - stunnel
          - openconnect
          - l2tp_ipsec
          - shadowsocks
          - tor
          - wireguard
        enabled_modules: []

    - name: Setting default module flags
      when: vars.get('disable-all', "0") == "0"
      set_fact:
        enabled_modules: "{{ all_modules }}"

    - name: Checking "only" modules flags
      when: vars.get(item + '-only', "0") == "1"
      set_fact:
        enabled_modules:
          - "{{ item }}"
      with_items: "{{ all_modules }}"

    - name: Checking enable modules flags
      when: vars.get('enable-' + item, "0") == "1"
      set_fact:
        enabled_modules: "{{ enabled_modules | difference(item) }}"
      with_items:
        "{{ all_modules }}"

    - name: Checking disable modules flags
      when: vars.get('disable-' + item, "0") == "1"
      set_fact:
        enabled_modules: "{{ enabled_modules | difference(item) }}"
      with_items:
        "{{ all_modules }}"

    - name: Checking enable modules flags
      when: vars.get('enable-' + item, "0") == "1" and vars.get('disable-' + item, "0") == "0"
      set_fact:
        enabled_modules: "{{ enabled_modules + [item] }}"
      with_items:
        "{{ all_modules }}"

    - name: Assigning enable flag vars
      set_fact:
        "enable_{{ item }}": true
      with_items:
        "{{ enabled_modules }}"

    - name: Assigning disable flag vars
      when: vars.get('enable_' + item, false) == false
      set_fact:
        "enable_{{ item }}": false
      with_items:
        "{{ all_modules }}"

    # Stunnel depends on OpenVPN
    - name: Checking OpenVPN and Stunnel flag dependency
      when: enable_stunnel
      set_fact:
        enable_openvpn: true

# A provider has been chosen
- include: "{{ provider }}.yml"
