---
- name: Create the nghttpx Gateway directory
  file:
    path: "{{ nghttpx_gateway_location }}"
    owner: www-data
    group: www-data
    mode: 0750
    state: directory

- name: Generate the PAC file to use HTTP/2 proxy
  template:
    src: proxy.pac.j2
    dest: "{{ nghttpx_pac_file }}"

- name: Convert the PAC to base64 for use in data URI
  command: base64 --wrap=0 {{ nghttpx_pac_file }}
  register: nghttpx_pac_base64
  changed_when: False

- name: Generate the Markdown nghttpx instructions
  template:
    src: instructions{{ item.value.file_suffix }}.md.j2
    dest: "{{ nghttpx_gateway_location }}/index{{ item.value.file_suffix }}.md"
  with_dict: "{{ streisand_languages }}"

- name: Convert the Markdown nghttpx instructions into HTML and surround them with the header and footer template
  shell: markdown {{ nghttpx_gateway_location }}/index{{ item.value.file_suffix }}.md | cat {{ streisand_i18n_header_template }} - {{ streisand_footer_template }} > {{ nghttpx_gateway_location }}/index{{ item.value.file_suffix }}.html
  with_dict: "{{ streisand_languages }}"
