---
- name: Install the ocserv dependencies
  apt:
    name: "{{ item }}"
  with_items: "{{ ocserv_dependencies }}"

- name: Retrieve the ocserv source code
  get_url:
    # This CDN mirrors the ocserv source code, and helps
    # mitigate connection errors that were occurring when
    # using the project's official download location.
    url: https://d25kfp60e9u1dw.cloudfront.net/{{ ocserv_source_filename }}
    dest: "{{ ocserv_source_location }}"
    checksum: "{{ ocserv_checksum }}"
    owner: root
    group: root
    mode: 0644

- name: Extract the ocserv source code
  unarchive:
    copy: no
    src: "{{ ocserv_source_location }}"
    dest: /usr/local/src
    owner: root
    group: root
    creates: "{{ ocserv_compilation_directory }}/README.md"

- name: Compile and install ocserv
  shell: ./configure && make -j {{ ansible_processor_cores }} && make install
  args:
    chdir: "{{ ocserv_compilation_directory }}"
    creates: "{{ ocserv_compilation_directory }}/config.log"
