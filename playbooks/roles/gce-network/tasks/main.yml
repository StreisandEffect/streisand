---
- name: Create network
  gce_net:
    name: "{{ gce_network }}"
    state: "present"
    mode: auto
    ipv4_range: "{{ gce_ipv4_range }}"
    credentials_file: "{{ gce_json_file_location }}"
    project_id: "{{ gce_project_id }}"
    service_account_email: "{{ gce_service_account_email }}"

- name: Open the SSH port in the GCE firewall
  gce_net:
    name: "{{ gce_network }}"
    fwname: "streisand-{{ gce_server_name }}-ssh"
    allowed: "tcp:{{ ssh_port }}"
    state: "present"
    mode: auto
    src_range: 0.0.0.0/0
    service_account_email: "{{ gce_service_account_email }}"
    credentials_file: "{{ gce_json_file_location }}"
    project_id: "{{ gce_project_id }}"

- name: Open the Nginx port in the GCE firewall
  gce_net:
    name: "{{ gce_network }}"
    fwname: "streisand-{{ gce_server_name }}-nginx"
    allowed: "tcp:{{ nginx_port }}"
    state: "present"
    mode: auto
    src_range: 0.0.0.0/0
    service_account_email: "{{ gce_service_account_email }}"
    credentials_file: "{{ gce_json_file_location }}"
    project_id: "{{ gce_project_id }}"

- name: Open HTTP port for Let's Encrypt in the GCE firewall
  gce_net:
    name: "{{ gce_network }}"
    fwname: "streisand-{{ gce_server_name }}-letsencrypt"
    allowed: "tcp:{{ le_port }}"
    state: "present"
    mode: auto
    src_range: 0.0.0.0/0
    service_account_email: "{{ gce_service_account_email }}"
    credentials_file: "{{ gce_json_file_location }}"
    project_id: "{{ gce_project_id }}"

- name: Open necessary Tor ports in the GCE firewall
  gce_net:
    name: "{{ gce_network }}"
    fwname: "streisand-{{ gce_server_name }}-tor"
    allowed: "tcp:{{ tor_orport }},{{ tor_obfs4_port }}"
    state: "present"
    mode: auto
    src_range: 0.0.0.0/0
    service_account_email: "{{ gce_service_account_email }}"
    credentials_file: "{{ gce_json_file_location }}"
    project_id: "{{ gce_project_id }}"
  when: streisand_tor_enabled

- name: Open the OpenConnect (ocserv) port in the GCE firewall
  gce_net:
    name: "{{ gce_network }}"
    fwname: "streisand-{{ gce_server_name }}-openconnect"
    allowed: "tcp:{{ ocserv_port }};udp:{{ ocserv_port }}"
    state: "present"
    mode: auto
    src_range: 0.0.0.0/0
    service_account_email: "{{ gce_service_account_email }}"
    credentials_file: "{{ gce_json_file_location }}"
    project_id: "{{ gce_project_id }}"
  when: streisand_openconnect_enabled

- name: Open the OpenVPN ports in the GCE firewall
  gce_net:
    name: "{{ gce_network }}"
    fwname: "streisand-{{ gce_server_name }}-openvpn"
    allowed: "tcp:{{ openvpn_port }};udp:{{ openvpn_port_udp }}"
    state: "present"
    mode: auto
    src_range: 0.0.0.0/0
    service_account_email: "{{ gce_service_account_email }}"
    credentials_file: "{{ gce_json_file_location }}"
    project_id: "{{ gce_project_id }}"
  when: streisand_openvpn_enabled

- name: Open the OpenVPN stunnel port in the GCE firewall
  gce_net:
    name: "{{ gce_network }}"
    fwname: "streisand-{{ gce_server_name }}-openvpn-stunnel"
    allowed: "tcp:{{ stunnel_remote_port }}"
    state: "present"
    mode: auto
    src_range: 0.0.0.0/0
    service_account_email: "{{ gce_service_account_email }}"
    credentials_file: "{{ gce_json_file_location }}"
    project_id: "{{ gce_project_id }}"
  when: streisand_openvpn_enabled and streisand_stunnel_enabled

- name: Open the Shadowsocks ports in the GCE firewall
  gce_net:
    name: "{{ gce_network }}"
    fwname: "streisand-{{ gce_server_name }}-shadowsocks"
    allowed: "tcp:{{ shadowsocks_server_port }};udp:{{ shadowsocks_server_port }}"
    state: "present"
    mode: auto
    src_range: 0.0.0.0/0
    service_account_email: "{{ gce_service_account_email }}"
    credentials_file: "{{ gce_json_file_location }}"
    project_id: "{{ gce_project_id }}"
  when: streisand_shadowsocks_enabled

- name: Open the WireGuard port in the GCE firewall
  gce_net:
    name: "{{ gce_network }}"
    fwname: "streisand-{{ gce_server_name }}-wireguard"
    allowed: "udp:{{ wireguard_port }}"
    state: "present"
    mode: auto
    src_range: 0.0.0.0/0
    service_account_email: "{{ gce_service_account_email }}"
    credentials_file: "{{ gce_json_file_location }}"
    project_id: "{{ gce_project_id }}"
  when: streisand_wireguard_enabled
