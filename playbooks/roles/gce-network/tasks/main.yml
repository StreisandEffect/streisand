---
- name: Create network
  gce_net:
    name: "{{ gce_network }}"
    state: "present"
    mode: auto
    ipv4_range: "{{ gce_ipv4_range }}"
    credentials_file: "{{ gce_json_file_location }}"
    project_id: "{{ gce_project_id }}"
    service_account_email: "{{ gce_service_account_email }}"

- name: Open the SSH port in the GCE firewall
  gce_net:
    name: "{{ gce_network }}"
    fwname: "streisand-{{ gce_server_name }}-ssh"
    allowed: "tcp:{{ ssh_port }}"
    state: "present"
    mode: auto
    src_range: 0.0.0.0/0
    service_account_email: "{{ gce_service_account_email }}"
    credentials_file: "{{ gce_json_file_location }}"
    project_id: "{{ gce_project_id }}"

- name: Open Nginx port in the GCE firewall
  gce_net:
    name: "{{ gce_network }}"
    fwname: "streisand-{{ gce_server_name }}-nginx"
    allowed: "tcp:{{ nginx_port }}"
    state: "present"
    mode: auto
    src_range: 0.0.0.0/0
    service_account_email: "{{ gce_service_account_email }}"
    credentials_file: "{{ gce_json_file_location }}"
    project_id: "{{ gce_project_id }}"

- name: Open the Stunnel port in the GCE firewall
  when: hostvars.localhost.enable_stunnel
  gce_net:
    name: "{{ gce_network }}"
    fwname: "streisand-{{ gce_server_name }}-stunnel"
    allowed: "tcp:{{ stunnel_remote_port }}"
    state: "present"
    mode: auto
    src_range: 0.0.0.0/0
    service_account_email: "{{ gce_service_account_email }}"
    credentials_file: "{{ gce_json_file_location }}"
    project_id: "{{ gce_project_id }}"

- name: Open the Tor ports in the GCE firewall
  when: hostvars.localhost.enable_tor
  gce_net:
    name: "{{ gce_network }}"
    fwname: "streisand-{{ gce_server_name }}-tor"
    allowed: "tcp:{{ tor_orport }},{{ tor_obfs4_port }}"
    state: "present"
    mode: auto
    src_range: 0.0.0.0/0
    service_account_email: "{{ gce_service_account_email }}"
    credentials_file: "{{ gce_json_file_location }}"
    project_id: "{{ gce_project_id }}"

- name: Open the L2TP/IPsec ports in the GCE firewall
  when: hostvars.localhost.enable_l2tp_ipsec
  gce_net:
    name: "{{ gce_network }}"
    fwname: "streisand-{{ gce_server_name }}-l2tp-ipsec"
    allowed: "udp:500,4500,1701"
    state: "present"
    mode: auto
    src_range: 0.0.0.0/0
    service_account_email: "{{ gce_service_account_email }}"
    credentials_file: "{{ gce_json_file_location }}"
    project_id: "{{ gce_project_id }}"

- name: Open the OpenConnect (ocserv) port in the GCE firewall
  when: hostvars.localhost.enable_openconnect
  gce_net:
    name: "{{ gce_network }}"
    fwname: "streisand-{{ gce_server_name }}-openconnect"
    allowed: "tcp:{{ ocserv_port }};udp:{{ ocserv_port }}"
    state: "present"
    mode: auto
    src_range: 0.0.0.0/0
    service_account_email: "{{ gce_service_account_email }}"
    credentials_file: "{{ gce_json_file_location }}"
    project_id: "{{ gce_project_id }}"

- name: Open the OpenVPN port in the GCE firewall
  when: hostvars.localhost.enable_openvpn
  gce_net:
    name: "{{ gce_network }}"
    fwname: "streisand-{{ gce_server_name }}-openvpn"
    allowed: "tcp:{{ openvpn_port }};udp:{{ openvpn_port_udp }}"
    state: "present"
    mode: auto
    src_range: 0.0.0.0/0
    service_account_email: "{{ gce_service_account_email }}"
    credentials_file: "{{ gce_json_file_location }}"
    project_id: "{{ gce_project_id }}"

- name: Open the Shadowsocks port in the GCE firewall
  when: hostvars.localhost.enable_shadowsocks
  gce_net:
    name: "{{ gce_network }}"
    fwname: "streisand-{{ gce_server_name }}-shadowsocks"
    allowed: "tcp:{{ shadowsocks_server_port }};udp:{{ shadowsocks_server_port }}"
    state: "present"
    mode: auto
    src_range: 0.0.0.0/0
    service_account_email: "{{ gce_service_account_email }}"
    credentials_file: "{{ gce_json_file_location }}"
    project_id: "{{ gce_project_id }}"

- name: Open the WireGuard port in the GCE firewall
  when: hostvars.localhost.enable_wireguard
  gce_net:
    name: "{{ gce_network }}"
    fwname: "streisand-{{ gce_server_name }}-wireguard"
    allowed: "udp:{{ wireguard_port }}"
    state: "present"
    mode: auto
    src_range: 0.0.0.0/0
    service_account_email: "{{ gce_service_account_email }}"
    credentials_file: "{{ gce_json_file_location }}"
    project_id: "{{ gce_project_id }}"
