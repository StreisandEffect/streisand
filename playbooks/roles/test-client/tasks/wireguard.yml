---

# Install the WireGuard PPA and packages
- include: "../../wireguard/tasks/install.yml"
  tags:
   - wireguard

- name: "Download the WireGuard wg0-client config file"
  get_url:
    url: "{{ gateway_wireguard_config }}"
    dest: "{{ wireguard_config }}"
    force_basic_auth: yes
    url_username: "{{ gateway_test_user }}"
    url_password: "{{ lookup('file', '{{ streisand_gateway_password_localpath }}') }}"
    validate_certs: no
    mode: 0600
  tags:
   - wireguard

- name: "Register the original /etc/resolv.conf contents"
  slurp:
    src: /etc/resolv.conf
  register: client_resolv_conf
  tags:
    - wireguard

- name: "Bring up the WireGuard interface"
  command: "wg-quick up wg0-client"
  tags:
   - wireguard

- name: "Register the modified /etc/resolv.conf contents"
  slurp:
    src: /etc/resolv.conf
  register: wgclient_resolv_conf
  tags:
    - wireguard

- name: "Assert that the DNS was updated for the DNSMasq WireGuard IP"
  assert:
    that:
      - "\"{{ wgclient_resolv_conf['content'] | b64decode }}\" == \"# Generated by resolvconf\nnameserver 10.192.122.1\n\""
  tags:
    - wireguard

- name: "Check {{ external_test_url }} through the WireGuard route"
  get_url:
    url: "{{ external_test_url }}"
    dest: "/dev/null"
  tags:
   - wireguard

- name: "Bring down the WireGuard interface"
  command: "wg-quick down wg0-client"

- name: "Re-Register the /etc/resolv.conf contents"
  slurp:
    src: /etc/resolv.conf
  register: wgclient_resolv_conf
  tags:
    - wireguard

- name: "Assert that the DNS was restored to pre-WireGuard state"
  assert:
    that:
      - "\"{{ wgclient_resolv_conf['content'] | b64decode }}\" ==  \"{{ client_resolv_conf['content'] | b64decode }}\""
  tags:
    - wireguard

