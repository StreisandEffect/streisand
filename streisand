#!/usr/bin/env bash
# Streisand provisioning script

set -e

echo
echo -e "\033[38;5;255m\033[48;5;234m\033[1m  S T R E I S A N D  \033[0m"
echo

command -v ansible > /dev/null 2>&1 || {
  echo "Ansible is not installed."
  exit 1
}

required_ansible_version="2.2.1.0"

if [[ "$(ansible --version | grep -oe '2\(.[0-9]\)*')" < $required_ansible_version ]]
then
    echo "Ansible $required_ansible_version or higher is required."
    exit 1
fi

# As long as there is at least one more argument, keep looping
extra_vars=""
while [[ $# -gt 0 ]]; do
    key="${1#--}"
    disable_prefix="disable-"
    only_sufix="-only"
    [[ ${key} != "${key#${disable_prefix}}" ]] && extra_vars="${key}=1 ${extra_vars}";
    [[ ${key} != "${key%${only_sufix}}" ]] && extra_vars="${key}=1 ${extra_vars}";
    shift
done

echo -n "Which provider are you using?
  1. Amazon
  2. Azure
  3. DigitalOcean
  4. Google
  5. Linode
  6. Rackspace
: "

read reply

case "$reply" in
  1) provider="amazon";;
  2) provider="azure";;
  3) provider="digitalocean";;
  4) provider="google";;
  5) provider="linode";;
  6) provider="rackspace";;
  *) echo; echo "Invalid provider selected."; exit 1;;
esac

ansible-playbook playbooks/main.yml --extra-vars "\
provider=${provider} \
${extra_vars}"